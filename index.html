<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç”Ÿæ½”ç‰™è¨˜éŒ„è¡¨ (GitHub ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); min-height: 100vh; }
    
    .seat-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .seat-btn:active { transform: scale(0.95); }
    .brushed { background-color: white !important; color: #0369a1 !important; border: 3px solid #0ea5e9; }
    .not-brushed { background-color: #0ea5e9; color: white; border: 3px solid transparent; }
    
    .watermark { position: fixed; bottom: 10px; right: 15px; opacity: 0.4; font-size: 14px; pointer-events: none; color: #64748b; }
    .loading-overlay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); }
    
    /* Tab Styles */
    .tab-btn { @apply px-4 sm:px-6 py-3 font-bold text-sky-100 transition-colors rounded-t-lg text-sm sm:text-base; }
    .tab-btn.active { @apply bg-white text-sky-600 shadow-sm; }
    .tab-btn:not(.active):hover { @apply text-white bg-sky-700/50; }

    /* Weekly Table Styles */
    .weekly-table th { @apply bg-sky-100 text-sky-800 p-3 border border-sky-200 text-center whitespace-nowrap sticky top-0 font-bold; }
    .weekly-table td { @apply p-2 border border-sky-100 text-center align-middle h-14 w-14 sm:w-auto; }
    .weekly-table tr:nth-child(even) { @apply bg-sky-50/50; }
    
    /* Weekly Toggle Button */
    .weekly-cell-btn { 
      @apply w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center mx-auto transition-all cursor-pointer;
    }
    .status-yes { @apply bg-white border-2 border-green-500 text-green-600; }
    .status-no { @apply bg-gray-200 text-gray-400 border-2 border-transparent hover:bg-gray-300; }
    .status-none { @apply text-gray-300 text-xs; }
  </style>
</head>
<body class="p-4 md:p-8">

  <script>
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxnRnPEUsDCbaPDJ4fDkWiY5m-hNeC7aIacQ9MFLe-6odNaQcZa9ohSb-y2uxOfdGgq/exec";
  </script>

  <div class="max-w-6xl mx-auto rounded-3xl shadow-2xl overflow-hidden animate__animated animate__fadeIn">
    
    <!-- Header -->
    <div class="bg-sky-600 px-6 pt-6 pb-0">
      <div class="flex flex-col md:flex-row justify-between items-center mb-4">
        <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center mb-4 md:mb-0">
          <span class="mr-2">ğŸ¦·</span> å­¸ç”Ÿæ½”ç‰™è¨˜éŒ„è¡¨
        </h1>
      </div>
      
      <!-- Tabs -->
      <div class="flex overflow-x-auto">
        <button id="tab-today" onclick="switchTab('today')" class="tab-btn active shrink-0">ä»Šæ—¥è¨˜éŒ„</button>
        <button id="tab-history" onclick="switchTab('history')" class="tab-btn shrink-0">å–®æ—¥æŸ¥è©¢/ä¿®æ”¹</button>
        <button id="tab-weekly" onclick="switchTab('weekly')" class="tab-btn shrink-0">ä¸€é€±ç¸½è¦½ (å¯ç·¨è¼¯)</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white min-h-[500px] flex flex-col">
      
      <!-- Controls -->
      <div class="p-6 border-b border-gray-100 bg-sky-50">
        
        <!-- Today Controls -->
        <div id="controls-today" class="mode-control flex flex-col md:flex-row items-center gap-4">
          <div class="flex items-center gap-3">
            <label class="text-gray-700 font-medium">å­¸ç”Ÿäººæ•¸ï¼š</label>
            <input type="number" id="studentCount" min="1" max="100" value="30" class="w-20 px-3 py-2 border-2 border-sky-200 rounded-lg text-lg">
            <button onclick="generateSeats()" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 font-medium">é‡è¨­åº§è™Ÿ</button>
          </div>
          <div class="text-sm text-sky-600 font-medium ml-auto">
            ä»Šæ—¥æ—¥æœŸï¼š<span id="displayDate" class="text-lg font-bold"></span>
          </div>
        </div>

        <!-- History Controls -->
        <div id="controls-history" class="mode-control hidden flex flex-col md:flex-row items-center gap-4 w-full">
          <div class="flex items-center gap-3 w-full">
            <label class="text-gray-700 font-medium">æŸ¥è©¢æ—¥æœŸï¼š</label>
            <input type="date" id="queryDate" class="px-3 py-2 border-2 border-sky-200 rounded-lg text-lg text-gray-700">
            <button onclick="queryData()" class="bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600 font-medium shadow-sm flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
              æŸ¥è©¢
            </button>
          </div>
        </div>

        <!-- Weekly Controls -->
        <div id="controls-weekly" class="mode-control hidden flex flex-col md:flex-row items-center gap-4 w-full justify-between">
          <div class="flex items-center gap-3">
            <label class="text-gray-700 font-medium">èµ·å§‹æ—¥æœŸ (é€±ä¸€)ï¼š</label>
            <input type="date" id="weeklyStartDate" class="px-3 py-2 border-2 border-sky-200 rounded-lg text-lg text-gray-700">
            <button onclick="queryWeeklyData()" class="bg-emerald-500 text-white px-6 py-2 rounded-lg hover:bg-emerald-600 font-medium shadow-sm flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
              é¡¯ç¤ºä¸€é€±è¨˜éŒ„
            </button>
          </div>
          <div class="text-sm text-gray-500 mt-2 md:mt-0">
             ğŸ’¡ é»æ“Šè¡¨æ ¼å…§åœ“åœˆå¯ä¿®æ”¹ç‹€æ…‹
          </div>
        </div>

      </div>

      <!-- Views -->
      <div class="relative flex-grow">
        
        <!-- Grid View (Today/History) -->
        <div id="seatsGrid" class="p-6 grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-6 justify-items-center min-h-[300px]"></div>
        
        <!-- Weekly Table View -->
        <div id="weeklyView" class="hidden p-6 overflow-x-auto min-h-[300px]">
          <table class="w-full weekly-table border-collapse">
            <thead>
              <tr id="weeklyHeaderRow"></tr>
            </thead>
            <tbody id="weeklyBody"></tbody>
          </table>
          <div id="weeklyEmpty" class="hidden text-center text-gray-400 mt-10">
            <p class="text-lg">è«‹é¸æ“‡èµ·å§‹æ—¥æœŸä¸¦é»æ“Šã€Œé¡¯ç¤ºä¸€é€±è¨˜éŒ„ã€</p>
          </div>
          
          <!-- Weekly Action Buttons -->
          <div id="weeklyActions" class="hidden mt-8 flex justify-center gap-6">
            <button onclick="switchTab('today')" class="px-6 py-3 border-2 border-gray-300 text-gray-600 rounded-xl hover:bg-gray-100 font-bold flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
              å›è¨˜éŒ„ç•«é¢
            </button>
            <button onclick="saveWeeklyChanges()" class="px-8 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold shadow-lg flex items-center gap-2 transform transition-transform hover:scale-105">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
              å„²å­˜æœ¬é€±ä¿®æ”¹
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none">
          <svg class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
          <p class="text-lg">è«‹é¸æ“‡æ—¥æœŸä¸¦æŸ¥è©¢</p>
        </div>
      </div>

      <!-- Footer (Today/History only) -->
      <div id="footer-actions" class="p-6 border-t border-gray-100 flex justify-between items-center bg-gray-50">
        <button onclick="resetUI()" class="flex items-center gap-2 px-6 py-2 border-2 border-gray-300 text-gray-500 rounded-xl hover:bg-white transition-all font-medium">
          é‡ç½®
        </button>

        <div class="flex gap-4">
          <button id="btn-delete" onclick="deleteData()" class="hidden bg-red-100 text-red-600 border-2 border-red-200 px-6 py-2 rounded-xl font-bold hover:bg-red-200 transition-colors">
            åˆªé™¤æ­¤æ—¥è¨˜éŒ„
          </button>
          <button id="btn-submit" onclick="submitRecords()" class="bg-sky-600 text-white px-8 py-2 rounded-xl font-bold hover:bg-sky-700 transition-colors shadow-md flex items-center gap-2">
            <span id="submit-text">çµæŸè¨˜éŒ„ (å„²å­˜)</span>
          </button>
        </div>
      </div>

    </div>
  </div>

  <div class="watermark">æ–‡å›è£½ä½œ</div>

  <!-- Loading & Message -->
  <div id="loader" class="hidden fixed inset-0 loading-overlay flex flex-col items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-sky-600"></div>
    <p id="loader-text" class="mt-4 text-sky-800 font-bold">è™•ç†ä¸­...</p>
  </div>
  <div id="messageBox" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-white border-l-4 shadow-xl p-4 rounded-lg z-50 animate__animated animate__fadeInDown">
    <span id="messageText" class="text-gray-800 font-medium"></span>
  </div>

  <script>
    let brushedSeats = new Set();
    let currentMode = 'today'; 
    let currentQueryDate = ''; 
    
    // ç”¨æ–¼å„²å­˜é€±æª¢è¦–çš„å³æ™‚è³‡æ–™ç‹€æ…‹ [seat]: [status_day0, status_day1...]
    let weeklyDataCache = {}; 
    let weeklyDates = []; 

    const today = new Date();
    const formattedToday = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + today.getDate().toString().padStart(2, '0');
    document.getElementById('displayDate').innerText = formattedToday;
    
    document.getElementById('queryDate').valueAsDate = new Date();
    const day = today.getDay();
    const diff = today.getDate() - day + (day == 0 ? -6 : 1); 
    const monday = new Date(today.setDate(diff));
    document.getElementById('weeklyStartDate').valueAsDate = monday;

    window.onload = () => { generateSeats(); };

    function switchTab(mode) {
      currentMode = mode;
      
      ['today', 'history', 'weekly'].forEach(m => {
        document.getElementById(`tab-${m}`).className = `tab-btn shrink-0 ${mode === m ? 'active' : ''}`;
        document.getElementById(`controls-${m}`).classList.add('hidden');
      });
      document.getElementById(`controls-${mode}`).classList.remove('hidden');

      const grid = document.getElementById('seatsGrid');
      const weekly = document.getElementById('weeklyView');
      const empty = document.getElementById('emptyState');
      const footer = document.getElementById('footer-actions');

      grid.classList.add('hidden');
      weekly.classList.add('hidden');
      empty.classList.add('hidden');
      footer.classList.remove('hidden'); // Default show

      if (mode === 'today') {
        grid.classList.remove('hidden');
        document.getElementById('btn-submit').classList.remove('hidden');
        document.getElementById('btn-delete').classList.add('hidden');
        document.getElementById('submit-text').innerText = "çµæŸè¨˜éŒ„ (å„²å­˜)";
        resetUI();
      } else if (mode === 'history') {
        grid.classList.remove('hidden');
        empty.classList.remove('hidden');
        document.getElementById('btn-submit').classList.add('hidden');
        document.getElementById('btn-delete').classList.add('hidden');
        document.getElementById('submit-text').innerText = "ä¿®æ”¹ä¸¦å„²å­˜";
        grid.innerHTML = '';
      } else if (mode === 'weekly') {
        weekly.classList.remove('hidden');
        footer.classList.add('hidden'); // Hide bottom footer in weekly mode
        document.getElementById('weeklyEmpty').classList.remove('hidden');
        document.getElementById('weeklyActions').classList.add('hidden');
        document.getElementById('weeklyBody').innerHTML = '';
        document.getElementById('weeklyHeaderRow').innerHTML = '';
      }
    }

    // --- é€±æª¢è¦–é‚è¼¯ ---
    async function queryWeeklyData() {
      const startDate = document.getElementById('weeklyStartDate').value;
      if (!startDate) { showMessage("è«‹é¸æ“‡èµ·å§‹æ—¥æœŸ", "border-red-500"); return; }
      if (!validateUrl()) return;

      showLoader("è®€å–é€±è³‡æ–™...");
      try {
        const url = `${GAS_WEB_APP_URL.trim()}?action=weekly_query&startDate=${startDate}`;
        const response = await fetch(url);
        const json = await response.json();
        hideLoader();

        if (json.status === 'success') {
           weeklyDates = json.dates;
           weeklyDataCache = json.data;
           renderWeeklyTable();
           document.getElementById('weeklyEmpty').classList.add('hidden');
           document.getElementById('weeklyActions').classList.remove('hidden');
        } else {
           showMessage(json.message, "border-red-500");
        }
      } catch (err) {
        hideLoader();
        showMessage("æŸ¥è©¢å¤±æ•—ï¼š" + err, "border-red-500");
      }
    }

    function renderWeeklyTable() {
      const headerRow = document.getElementById('weeklyHeaderRow');
      const body = document.getElementById('weeklyBody');
      headerRow.innerHTML = '<th>åº§è™Ÿ</th>';
      body.innerHTML = '';

      weeklyDates.forEach(d => {
        const th = document.createElement('th');
        th.innerText = d;
        headerRow.appendChild(th);
      });

      const seats = Object.keys(weeklyDataCache).map(Number).sort((a,b) => a-b);
      
      seats.forEach(seat => {
        const tr = document.createElement('tr');
        
        // åº§è™Ÿ
        const tdSeat = document.createElement('td');
        tdSeat.className = "font-bold text-sky-700 bg-sky-50";
        tdSeat.innerText = seat;
        tr.appendChild(tdSeat);

        // ç‹€æ…‹æ ¼
        const weekStatus = weeklyDataCache[seat]; 
        weekStatus.forEach((status, dayIndex) => {
          const td = document.createElement('td');
          
          const btn = document.createElement('div');
          btn.className = "weekly-cell-btn";
          
          if (status === 'æ˜¯') {
             btn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>';
             btn.classList.add('status-yes');
             btn.onclick = () => toggleWeeklyCell(seat, dayIndex, 'å¦');
          } else if (status === 'å¦') {
             btn.innerText = "";
             btn.classList.add('status-no');
             btn.onclick = () => toggleWeeklyCell(seat, dayIndex, 'æ˜¯');
          } else {
             // ç„¡è³‡æ–™ç‹€æ…‹ï¼Œé è¨­é»æ“Šè®Š "æ˜¯" (å»ºç«‹è³‡æ–™)
             btn.innerText = "-";
             btn.classList.add('status-none');
             btn.onclick = () => toggleWeeklyCell(seat, dayIndex, 'æ˜¯');
          }
          
          td.appendChild(btn);
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    function toggleWeeklyCell(seat, dayIndex, newStatus) {
      // æ›´æ–° Cache
      weeklyDataCache[seat][dayIndex] = newStatus;
      // å±€éƒ¨é‡æ–°æ¸²æŸ“ (ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œç›´æ¥é‡ç¹ªè¡¨æ ¼ï¼Œè³‡æ–™é‡å°ä¸å½±éŸ¿æ•ˆèƒ½)
      renderWeeklyTable();
    }

    async function saveWeeklyChanges() {
      if (!validateUrl()) return;
      showLoader("æ­£åœ¨å„²å­˜æœ¬é€±ä¿®æ”¹...");

      // å°‡ weeklyDataCache è½‰æ›ç‚ºå¾Œç«¯ batchSave éœ€è¦çš„æ ¼å¼
      // dataset: [ { date: "02/02", records: {1:"æ˜¯"...} }, ... ]
      let dataset = [];
      
      weeklyDates.forEach((dateStr, index) => {
        let dailyRecords = {};
        let hasData = false;
        
        for (const seat in weeklyDataCache) {
          const status = weeklyDataCache[seat][index];
          // éæ¿¾æ‰ '-' (æœªå»ºç«‹ä¸”æœªä¿®æ”¹) çš„è³‡æ–™ï¼Œåªå„²å­˜ 'æ˜¯' æˆ– 'å¦'
          if (status === 'æ˜¯' || status === 'å¦') {
            dailyRecords[seat] = status;
            hasData = true;
          }
        }
        
        // å³ä½¿è©²æ—¥å…¨éƒ¨éƒ½æ˜¯ "å¦"ï¼Œåªè¦æœ‰ç·¨è¼¯éæˆ–åŸæœ¬æœ‰è³‡æ–™ï¼Œå°±é€å‡º
        if (hasData) {
          dataset.push({
            date: dateStr,
            records: dailyRecords
          });
        }
      });

      try {
        const response = await fetch(GAS_WEB_APP_URL.trim(), {
          method: "POST",
          body: JSON.stringify({ action: 'batch_save', dataset: dataset }),
          headers: { "Content-Type": "text/plain" }
        });
        const result = await response.json();
        hideLoader();
        
        if (result.status === 'success') {
          showMessage(result.message, "border-green-500");
        } else {
          showMessage("å„²å­˜å¤±æ•—ï¼š" + result.message, "border-red-500");
        }
      } catch (err) {
        hideLoader();
        showMessage("é€£ç·šç•°å¸¸ï¼Œä½†è«‹æ±‚å·²ç™¼é€", "border-blue-500");
      }
    }

    // --- å…¶ä»–åŠŸèƒ½ ---
    function generateSeats(seatData = null) {
      const count = parseInt(document.getElementById('studentCount').value);
      const grid = document.getElementById('seatsGrid');
      grid.innerHTML = '';
      if (!seatData) brushedSeats.clear();

      for (let i = 1; i <= count; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.id = `seat-${i}`;
        
        let isBrushed = false;
        if (seatData) isBrushed = (seatData[i] === 'æ˜¯');
        else isBrushed = brushedSeats.has(i);

        btn.className = isBrushed 
          ? 'seat-btn brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center'
          : 'seat-btn not-brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
        
        if (isBrushed) brushedSeats.add(i);

        btn.onclick = () => {
          if (brushedSeats.has(i)) { 
            brushedSeats.delete(i); 
            btn.className = 'seat-btn not-brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
          } else { 
            brushedSeats.add(i); 
            btn.className = 'seat-btn brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
          }
        };
        grid.appendChild(btn);
      }
    }
    
    // çœç•¥éƒ¨åˆ†é‡è¤‡çš„ queryData, submitRecords å‡½æ•¸ï¼Œä¿æŒåŸæ¨£å³å¯ï¼Œæ­¤è™•ç‚ºå®Œæ•´æ•´åˆ
    function formatDateToMMDD(dateString) {
      const parts = dateString.split('-'); 
      if (parts.length === 3) return `${parts[1]}/${parts[2]}`;
      return dateString;
    }

    async function queryData() {
      const dateInput = document.getElementById('queryDate').value;
      if (!dateInput) { showMessage("è«‹é¸æ“‡æ—¥æœŸ", "border-red-500"); return; }
      currentQueryDate = formatDateToMMDD(dateInput);
      if (!validateUrl()) return;

      showLoader("æŸ¥è©¢ä¸­...");
      try {
        const url = `${GAS_WEB_APP_URL.trim()}?action=query&date=${currentQueryDate}`;
        const response = await fetch(url);
        const json = await response.json();
        hideLoader();

        if (json.status === 'success') {
          document.getElementById('emptyState').classList.add('hidden');
          const seats = Object.keys(json.data).map(Number);
          const maxSeat = seats.length > 0 ? Math.max(...seats) : 30;
          document.getElementById('studentCount').value = maxSeat;
          generateSeats(json.data);
          document.getElementById('btn-submit').classList.remove('hidden');
          document.getElementById('btn-delete').classList.remove('hidden');
          showMessage(`è¼‰å…¥ ${currentQueryDate} è³‡æ–™`, "border-green-500");
        } else {
          showMessage(json.message || "æŸ¥ç„¡è³‡æ–™", "border-amber-500");
          document.getElementById('seatsGrid').innerHTML = '';
          document.getElementById('emptyState').classList.remove('hidden');
          document.getElementById('btn-submit').classList.add('hidden');
          document.getElementById('btn-delete').classList.add('hidden');
        }
      } catch (err) {
        hideLoader();
        showMessage("æŸ¥è©¢å¤±æ•—", "border-red-500");
      }
    }

    async function deleteData() {
      if (!confirm(`ç¢ºå®šåˆªé™¤ ${currentQueryDate} è¨˜éŒ„ï¼Ÿ`)) return;
      if (!validateUrl()) return;
      showLoader("åˆªé™¤ä¸­...");
      try {
        await fetch(GAS_WEB_APP_URL.trim(), {
          method: "POST",
          body: JSON.stringify({ action: 'delete', date: currentQueryDate }),
          headers: { "Content-Type": "text/plain" }
        });
        hideLoader();
        showMessage("å·²é€å‡ºåˆªé™¤è«‹æ±‚", "border-green-500");
        resetUI();
      } catch (err) {
        hideLoader();
        showMessage("å·²é€å‡ºè«‹æ±‚", "border-gray-500");
      }
    }

    async function submitRecords() {
      if (!validateUrl()) return;
      const count = parseInt(document.getElementById('studentCount').value);
      const records = {};
      for (let i = 1; i <= count; i++) { records[i] = brushedSeats.has(i) ? "æ˜¯" : "å¦"; }
      const targetDate = (currentMode === 'today') ? formattedToday : currentQueryDate;

      showLoader("å„²å­˜ä¸­...");
      try {
        const response = await fetch(GAS_WEB_APP_URL.trim(), {
          method: "POST",
          body: JSON.stringify({ action: 'save', date: targetDate, records: records }),
          headers: { "Content-Type": "text/plain" }
        });
        const result = await response.json();
        hideLoader();
        showMessage(result.message || "å„²å­˜æˆåŠŸ", "border-green-500");
      } catch (err) {
        hideLoader();
        showMessage("å·²é€å‡ºè³‡æ–™", "border-blue-500");
      }
    }

    function validateUrl() {
      if (!GAS_WEB_APP_URL || !GAS_WEB_APP_URL.includes("script.google.com")) {
        showMessage("éŒ¯èª¤ï¼šè«‹å…ˆè¨­å®š GAS ç¶²å€", "border-red-500");
        return false;
      }
      return true;
    }

    function resetUI() {
      if (currentMode === 'today') {
        generateSeats();
      } else if (currentMode === 'history') {
        document.getElementById('seatsGrid').innerHTML = '';
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('btn-submit').classList.add('hidden');
        document.getElementById('btn-delete').classList.add('hidden');
      } 
      showMessage("å·²é‡ç½®", "border-gray-500");
    }

    function showLoader(text) { document.getElementById('loader-text').innerText = text; document.getElementById('loader').classList.remove('hidden'); }
    function hideLoader() { document.getElementById('loader').classList.add('hidden'); }
    function showMessage(text, borderColor) {
      const box = document.getElementById('messageBox');
      const txt = document.getElementById('messageText');
      box.className = `fixed top-5 left-1/2 -translate-x-1/2 bg-white border-l-4 shadow-xl p-4 rounded-lg z-50 ${borderColor} animate__animated animate__fadeInDown`;
      txt.innerText = text;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>
