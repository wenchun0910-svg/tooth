<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç”Ÿæ½”ç‰™è¨˜éŒ„è¡¨ (GitHub ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); min-height: 100vh; }
    .seat-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .seat-btn:active { transform: scale(0.95); }
    .brushed { background-color: white !important; color: #0369a1 !important; border: 3px solid #0ea5e9; }
    .not-brushed { background-color: #0ea5e9; color: white; border: 3px solid transparent; }
    .watermark { position: fixed; bottom: 10px; right: 15px; opacity: 0.4; font-size: 14px; pointer-events: none; color: #64748b; }
    .loading-overlay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); }
    
    /* Tab Styles */
    .tab-btn { @apply px-6 py-3 font-bold text-sky-100 transition-colors rounded-t-lg; }
    .tab-btn.active { @apply bg-white text-sky-600 shadow-sm; }
    .tab-btn:not(.active):hover { @apply text-white bg-sky-700/50; }
  </style>
</head>
<body class="p-4 md:p-8">

  <!-- è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨ GAS éƒ¨ç½²å¾Œç²å¾—çš„ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€ -->
  <script>
    const GAS_WEB_APP_URL = "åœ¨æ­¤è²¼ä¸Šæ‚¨çš„_GAS_WEB_APP_URL";
  </script>

  <div class="max-w-4xl mx-auto rounded-3xl shadow-2xl overflow-hidden animate__animated animate__fadeIn">
    
    <!-- Header with Tabs -->
    <div class="bg-sky-600 px-6 pt-6 pb-0">
      <div class="flex flex-col md:flex-row justify-between items-center mb-4">
        <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center mb-4 md:mb-0">
          <span class="mr-2">ğŸ¦·</span> å­¸ç”Ÿæ½”ç‰™è¨˜éŒ„è¡¨
        </h1>
      </div>
      
      <!-- Tabs -->
      <div class="flex gap-2">
        <button id="tab-today" onclick="switchTab('today')" class="tab-btn active">ä»Šæ—¥è¨˜éŒ„</button>
        <button id="tab-history" onclick="switchTab('history')" class="tab-btn">æ­·å²æŸ¥è©¢ / ä¿®æ”¹</button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="bg-white min-h-[500px]">
      
      <!-- Control Panel -->
      <div class="p-6 border-b border-gray-100 bg-sky-50">
        
        <!-- Today Mode Controls -->
        <div id="controls-today" class="flex flex-col md:flex-row items-center gap-4">
          <div class="flex items-center gap-3">
            <label class="text-gray-700 font-medium">å­¸ç”Ÿäººæ•¸ï¼š</label>
            <input type="number" id="studentCount" min="1" max="100" value="30" class="w-20 px-3 py-2 border-2 border-sky-200 rounded-lg text-lg">
            <button onclick="generateSeats()" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 font-medium">é‡è¨­åº§è™Ÿ</button>
          </div>
          <div class="text-sm text-sky-600 font-medium ml-auto">
            ä»Šæ—¥æ—¥æœŸï¼š<span id="displayDate" class="text-lg font-bold"></span>
          </div>
        </div>

        <!-- History Mode Controls (Initially Hidden) -->
        <div id="controls-history" class="hidden flex flex-col md:flex-row items-center gap-4 w-full">
          <div class="flex items-center gap-3 w-full">
            <label class="text-gray-700 font-medium">æŸ¥è©¢æ—¥æœŸï¼š</label>
            <input type="date" id="queryDate" class="px-3 py-2 border-2 border-sky-200 rounded-lg text-lg text-gray-700">
            <button onclick="queryData()" class="bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600 font-medium shadow-sm flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
              æŸ¥è©¢
            </button>
          </div>
        </div>

      </div>

      <!-- Grid Container -->
      <div class="relative">
        <div id="seatsGrid" class="p-6 grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-6 justify-items-center min-h-[300px]">
          <!-- Seats generated here -->
        </div>
        
        <!-- Empty State Message -->
        <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <p class="text-lg">è«‹é¸æ“‡æ—¥æœŸä¸¦é»æ“ŠæŸ¥è©¢</p>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="p-6 border-t border-gray-100 flex justify-between items-center bg-gray-50">
        <button onclick="resetUI()" class="flex items-center gap-2 px-6 py-2 border-2 border-gray-300 text-gray-500 rounded-xl hover:bg-white transition-all font-medium">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
          ç•«é¢é‡ç½®
        </button>

        <div class="flex gap-4">
          <!-- History Mode Actions -->
          <button id="btn-delete" onclick="deleteData()" class="hidden bg-red-100 text-red-600 border-2 border-red-200 px-6 py-2 rounded-xl font-bold hover:bg-red-200 transition-colors">
            åˆªé™¤æ­¤æ—¥è¨˜éŒ„
          </button>
          
          <!-- Submit/Update Button -->
          <button id="btn-submit" onclick="submitRecords()" class="bg-sky-600 text-white px-8 py-2 rounded-xl font-bold hover:bg-sky-700 transition-colors shadow-md flex items-center gap-2">
            <span id="submit-text">çµæŸè¨˜éŒ„ (å„²å­˜)</span>
          </button>
        </div>
      </div>

    </div>
  </div>

  <div class="watermark">æ–‡å›è£½ä½œ</div>

  <!-- Loading -->
  <div id="loader" class="hidden fixed inset-0 loading-overlay flex flex-col items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-sky-600"></div>
    <p id="loader-text" class="mt-4 text-sky-800 font-bold">è³‡æ–™è™•ç†ä¸­...</p>
  </div>

  <!-- Message Box -->
  <div id="messageBox" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-white border-l-4 shadow-xl p-4 rounded-lg z-50 animate__animated animate__fadeInDown">
    <span id="messageText" class="text-gray-800 font-medium"></span>
  </div>

  <script>
    let brushedSeats = new Set();
    let currentMode = 'today'; // 'today' or 'history'
    let currentQueryDate = ''; // 'MM/DD'

    // åˆå§‹åŒ–æ—¥æœŸ
    const today = new Date();
    const formattedToday = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + today.getDate().toString().padStart(2, '0');
    document.getElementById('displayDate').innerText = formattedToday;

    // è¨­å®šæŸ¥è©¢æ—¥æœŸçš„é è¨­å€¼ç‚ºä»Šæ—¥
    document.getElementById('queryDate').valueAsDate = new Date();

    // åˆå§‹åŒ–
    window.onload = () => {
      generateSeats();
    };

    // åˆ‡æ›åˆ†é 
    function switchTab(mode) {
      currentMode = mode;
      document.getElementById('tab-today').className = `tab-btn ${mode === 'today' ? 'active' : ''}`;
      document.getElementById('tab-history').className = `tab-btn ${mode === 'history' ? 'active' : ''}`;
      
      if (mode === 'today') {
        document.getElementById('controls-today').classList.remove('hidden');
        document.getElementById('controls-history').classList.add('hidden');
        document.getElementById('btn-delete').classList.add('hidden');
        document.getElementById('submit-text').innerText = "çµæŸè¨˜éŒ„ (å„²å­˜)";
        document.getElementById('btn-submit').classList.remove('bg-amber-500', 'hover:bg-amber-600');
        document.getElementById('btn-submit').classList.add('bg-sky-600', 'hover:bg-sky-700');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('seatsGrid').classList.remove('hidden');
        
        // é‡ç½®ç‚ºä»Šæ—¥ç‹€æ…‹
        resetUI();
      } else {
        document.getElementById('controls-today').classList.add('hidden');
        document.getElementById('controls-history').classList.remove('hidden');
        document.getElementById('submit-text').innerText = "ä¿®æ”¹ä¸¦å„²å­˜";
        document.getElementById('btn-submit').classList.remove('bg-sky-600', 'hover:bg-sky-700');
        document.getElementById('btn-submit').classList.add('bg-amber-500', 'hover:bg-amber-600');
        
        // æ­·å²æ¨¡å¼åˆå§‹ç‹€æ…‹
        document.getElementById('seatsGrid').innerHTML = '';
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('btn-submit').classList.add('hidden');
        document.getElementById('btn-delete').classList.add('hidden');
      }
    }

    // ç”Ÿæˆåº§è™Ÿ
    function generateSeats(seatData = null) {
      const count = parseInt(document.getElementById('studentCount').value);
      const grid = document.getElementById('seatsGrid');
      grid.innerHTML = '';
      
      // å¦‚æœæ²’æœ‰å‚³å…¥ç‰¹å®šè³‡æ–™ï¼Œå‰‡æ¸…ç©ºé¸å–ç‹€æ…‹
      if (!seatData) brushedSeats.clear();

      for (let i = 1; i <= count; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.id = `seat-${i}`;
        
        // åˆ¤æ–·åˆå§‹ç‹€æ…‹
        let isBrushed = false;
        if (seatData) {
          if (seatData[i] === 'æ˜¯') isBrushed = true;
        } else {
          if (brushedSeats.has(i)) isBrushed = true;
        }

        if (isBrushed) {
          brushedSeats.add(i);
          btn.className = 'seat-btn brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
        } else {
          btn.className = 'seat-btn not-brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
        }

        btn.onclick = () => {
          if (brushedSeats.has(i)) { 
            brushedSeats.delete(i); 
            btn.className = 'seat-btn not-brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
          } else { 
            brushedSeats.add(i); 
            btn.className = 'seat-btn brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
          }
        };
        grid.appendChild(btn);
      }
    }

    // æ ¼å¼åŒ–æ—¥æœŸ YYYY-MM-DD -> MM/DD
    function formatDateToMMDD(dateString) {
      const parts = dateString.split('-'); // [YYYY, MM, DD]
      if (parts.length === 3) {
        return `${parts[1]}/${parts[2]}`;
      }
      return dateString;
    }

    // æŸ¥è©¢è³‡æ–™
    async function queryData() {
      const dateInput = document.getElementById('queryDate').value;
      if (!dateInput) {
        showMessage("è«‹é¸æ“‡æ—¥æœŸ", "border-red-500");
        return;
      }

      currentQueryDate = formatDateToMMDD(dateInput);
      
      if (!validateUrl()) return;

      showLoader("æŸ¥è©¢è³‡æ–™ä¸­...");

      try {
        const url = `${GAS_WEB_APP_URL.trim()}?action=query&date=${currentQueryDate}`;
        const response = await fetch(url);
        const json = await response.json();

        hideLoader();

        if (json.status === 'success') {
          // éš±è—ç©ºç‹€æ…‹ï¼Œé¡¯ç¤ºç¶²æ ¼
          document.getElementById('emptyState').classList.add('hidden');
          document.getElementById('seatsGrid').classList.remove('hidden');
          
          // æ ¹æ“šè³‡æ–™ç”ŸæˆæŒ‰éˆ•
          // æ‰¾å‡ºæœ€å¤§çš„åº§è™Ÿä»¥è¨­å®šäººæ•¸
          const seats = Object.keys(json.data).map(Number);
          const maxSeat = seats.length > 0 ? Math.max(...seats) : 30;
          document.getElementById('studentCount').value = maxSeat;
          
          brushedSeats.clear();
          generateSeats(json.data);
          
          // é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
          document.getElementById('btn-submit').classList.remove('hidden');
          document.getElementById('btn-delete').classList.remove('hidden');
          
          showMessage(`å·²è¼‰å…¥ ${currentQueryDate} çš„è³‡æ–™`, "border-green-500");
        } else {
          showMessage(json.message || "æŸ¥ç„¡è³‡æ–™", "border-amber-500");
          document.getElementById('seatsGrid').innerHTML = '';
          document.getElementById('emptyState').classList.remove('hidden');
          document.getElementById('btn-submit').classList.add('hidden');
          document.getElementById('btn-delete').classList.add('hidden');
        }

      } catch (err) {
        hideLoader();
        showMessage("æŸ¥è©¢å¤±æ•—ï¼š" + err, "border-red-500");
        console.error(err);
      }
    }

    // åˆªé™¤è³‡æ–™
    async function deleteData() {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${currentQueryDate} çš„æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;

      if (!validateUrl()) return;
      showLoader("åˆªé™¤ä¸­...");

      try {
        const response = await fetch(GAS_WEB_APP_URL.trim(), {
          method: "POST",
          // åˆªé™¤æ™‚æˆ‘å€‘éœ€è¦çŸ¥é“çµæœï¼Œæ‰€ä»¥å˜—è©¦ä¸ä½¿ç”¨ no-corsï¼Œ
          // ä½†å¦‚æœé‡åˆ° CORS éŒ¯èª¤ï¼Œä¼ºæœå™¨ç«¯å…¶å¯¦å·²ç¶“åŸ·è¡Œäº†ã€‚
          // ç‚ºäº†ç›¸å®¹æ€§ï¼Œæˆ‘å€‘å…ˆç”¨æ¨™æº–æ¨¡å¼ï¼Œè‹¥å¤±æ•—å‰‡æç¤ºæª¢æŸ¥
          body: JSON.stringify({ action: 'delete', date: currentQueryDate }),
          headers: { "Content-Type": "text/plain" }
        });
        
        const result = await response.json();
        hideLoader();
        
        if (result.status === 'success' || result.message.includes('å·²åˆªé™¤')) {
           showMessage("åˆªé™¤æˆåŠŸ", "border-green-500");
           // æ¸…ç©ºç•«é¢
           document.getElementById('seatsGrid').innerHTML = '';
           document.getElementById('emptyState').classList.remove('hidden');
           document.getElementById('btn-submit').classList.add('hidden');
           document.getElementById('btn-delete').classList.add('hidden');
        } else {
           showMessage("åˆªé™¤å›æ‡‰ï¼š" + result.message, "border-amber-500");
        }

      } catch (err) {
        hideLoader();
        // å³ä½¿ç™¼ç”Ÿ CORS éŒ¯èª¤ï¼Œé€šå¸¸è«‹æ±‚å·²ç™¼é€
        showMessage("å·²é€å‡ºåˆªé™¤è«‹æ±‚ (è‹¥æœªæ¶ˆå¤±è«‹é‡æ–°æ•´ç†)", "border-gray-500");
      }
    }

    // å„²å­˜æˆ–æ›´æ–°è³‡æ–™
    async function submitRecords() {
      if (!validateUrl()) return;

      const count = parseInt(document.getElementById('studentCount').value);
      const records = {};
      for (let i = 1; i <= count; i++) { records[i] = brushedSeats.has(i) ? "æ˜¯" : "å¦"; }

      // æ±ºå®šä½¿ç”¨çš„æ—¥æœŸï¼šä»Šæ—¥æ¨¡å¼ç”¨ formattedTodayï¼Œæ­·å²æ¨¡å¼ç”¨ currentQueryDate
      const targetDate = (currentMode === 'today') ? formattedToday : currentQueryDate;

      showLoader("è³‡æ–™å„²å­˜ä¸­...");

      try {
        const response = await fetch(GAS_WEB_APP_URL.trim(), {
          method: "POST",
          body: JSON.stringify({ action: 'save', date: targetDate, records: records }),
          headers: { "Content-Type": "text/plain" }
        });

        const result = await response.json();
        hideLoader();
        showMessage(result.message || "å„²å­˜æˆåŠŸ", "border-green-500");

      } catch (err) {
        hideLoader();
        // å¦‚æœæ˜¯æ­·å²ä¿®æ”¹æ¨¡å¼ï¼Œå¯èƒ½æœƒæœ‰ CORS è­¦å‘Šä½†æˆåŠŸ
        showMessage("å·²é€å‡ºè³‡æ–™", "border-blue-500");
      }
    }

    // å·¥å…·å‡½å¼
    function validateUrl() {
      if (!GAS_WEB_APP_URL || !GAS_WEB_APP_URL.includes("script.google.com")) {
        showMessage("éŒ¯èª¤ï¼šè«‹å…ˆè¨­å®š GAS ç¶²å€", "border-red-500");
        return false;
      }
      return true;
    }

    function resetUI() {
      if (currentMode === 'today') {
        generateSeats(); // é‡ç”Ÿç©ºç™½æŒ‰éˆ•
      } else {
        document.getElementById('queryDate').value = '';
        document.getElementById('seatsGrid').innerHTML = '';
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('btn-submit').classList.add('hidden');
        document.getElementById('btn-delete').classList.add('hidden');
      }
      showMessage("ç•«é¢å·²é‡ç½®", "border-gray-500");
    }

    function showLoader(text) {
      document.getElementById('loader-text').innerText = text;
      document.getElementById('loader').classList.remove('hidden');
    }

    function hideLoader() {
      document.getElementById('loader').classList.add('hidden');
    }

    function showMessage(text, borderColor) {
      const box = document.getElementById('messageBox');
      const txt = document.getElementById('messageText');
      box.className = `fixed top-5 left-1/2 -translate-x-1/2 bg-white border-l-4 shadow-xl p-4 rounded-lg z-50 ${borderColor} animate__animated animate__fadeInDown`;
      txt.innerText = text;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>
