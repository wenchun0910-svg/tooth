<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç”Ÿæ½”ç‰™è¨˜éŒ„è¡¨ (GitHub ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); min-height: 100vh; }
    .seat-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .seat-btn:active { transform: scale(0.95); }
    .brushed { background-color: white !important; color: #0369a1 !important; border: 3px solid #0ea5e9; }
    .not-brushed { background-color: #0ea5e9; color: white; border: 3px solid transparent; }
    .watermark { position: fixed; bottom: 10px; right: 15px; opacity: 0.4; font-size: 14px; pointer-events: none; color: #64748b; }
    .loading-overlay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); }
    
    /* Tab Styles */
    .tab-btn { @apply px-4 sm:px-6 py-3 font-bold text-sky-100 transition-colors rounded-t-lg text-sm sm:text-base; }
    .tab-btn.active { @apply bg-white text-sky-600 shadow-sm; }
    .tab-btn:not(.active):hover { @apply text-white bg-sky-700/50; }

    /* Table Styles */
    .weekly-table th { @apply bg-sky-100 text-sky-800 p-2 border border-sky-200 text-center whitespace-nowrap; }
    .weekly-table td { @apply p-2 border border-sky-100 text-center; }
    .weekly-table tr:nth-child(even) { @apply bg-sky-50/50; }
  </style>
</head>
<body class="p-4 md:p-8">

  <!-- è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨ GAS éƒ¨ç½²å¾Œç²å¾—çš„ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€ -->
  <script>
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzKwkvRJNBHgeNlXNoN29o21o2lQQCjvag48RgAjqLvCI--WlYH-9SvxdadhnyZd0oD/exec";
  </script>

  <div class="max-w-5xl mx-auto rounded-3xl shadow-2xl overflow-hidden animate__animated animate__fadeIn">
    
    <!-- Header with Tabs -->
    <div class="bg-sky-600 px-6 pt-6 pb-0">
      <div class="flex flex-col md:flex-row justify-between items-center mb-4">
        <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center mb-4 md:mb-0">
          <span class="mr-2">ğŸ¦·</span> å­¸ç”Ÿæ½”ç‰™è¨˜éŒ„è¡¨
        </h1>
      </div>
      
      <!-- Tabs -->
      <div class="flex overflow-x-auto">
        <button id="tab-today" onclick="switchTab('today')" class="tab-btn active shrink-0">ä»Šæ—¥è¨˜éŒ„</button>
        <button id="tab-history" onclick="switchTab('history')" class="tab-btn shrink-0">å–®æ—¥æŸ¥è©¢/ä¿®æ”¹</button>
        <button id="tab-weekly" onclick="switchTab('weekly')" class="tab-btn shrink-0">ä¸€é€±ç¸½è¦½</button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="bg-white min-h-[500px]">
      
      <!-- Control Panel -->
      <div class="p-6 border-b border-gray-100 bg-sky-50">
        
        <!-- Today Mode Controls -->
        <div id="controls-today" class="mode-control flex flex-col md:flex-row items-center gap-4">
          <div class="flex items-center gap-3">
            <label class="text-gray-700 font-medium">å­¸ç”Ÿäººæ•¸ï¼š</label>
            <input type="number" id="studentCount" min="1" max="100" value="30" class="w-20 px-3 py-2 border-2 border-sky-200 rounded-lg text-lg">
            <button onclick="generateSeats()" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 font-medium">é‡è¨­åº§è™Ÿ</button>
          </div>
          <div class="text-sm text-sky-600 font-medium ml-auto">
            ä»Šæ—¥æ—¥æœŸï¼š<span id="displayDate" class="text-lg font-bold"></span>
          </div>
        </div>

        <!-- History Mode Controls -->
        <div id="controls-history" class="mode-control hidden flex flex-col md:flex-row items-center gap-4 w-full">
          <div class="flex items-center gap-3 w-full">
            <label class="text-gray-700 font-medium">æŸ¥è©¢æ—¥æœŸï¼š</label>
            <input type="date" id="queryDate" class="px-3 py-2 border-2 border-sky-200 rounded-lg text-lg text-gray-700">
            <button onclick="queryData()" class="bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600 font-medium shadow-sm flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
              æŸ¥è©¢
            </button>
          </div>
        </div>

        <!-- Weekly Mode Controls -->
        <div id="controls-weekly" class="mode-control hidden flex flex-col md:flex-row items-center gap-4 w-full">
          <div class="flex items-center gap-3 w-full">
            <label class="text-gray-700 font-medium">èµ·å§‹æ—¥æœŸ (é€±ä¸€)ï¼š</label>
            <input type="date" id="weeklyStartDate" class="px-3 py-2 border-2 border-sky-200 rounded-lg text-lg text-gray-700">
            <button onclick="queryWeeklyData()" class="bg-emerald-500 text-white px-6 py-2 rounded-lg hover:bg-emerald-600 font-medium shadow-sm flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
              é¡¯ç¤ºä¸€é€±è¨˜éŒ„
            </button>
          </div>
        </div>

      </div>

      <!-- Content Views -->
      <div class="relative">
        
        <!-- 1. Seat Grid View (For Today & History) -->
        <div id="seatsGrid" class="p-6 grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-6 justify-items-center min-h-[300px]">
          <!-- Seats generated here -->
        </div>
        
        <!-- 2. Weekly Table View -->
        <div id="weeklyView" class="hidden p-6 overflow-x-auto min-h-[300px]">
          <table class="w-full weekly-table border-collapse">
            <thead>
              <tr id="weeklyHeaderRow">
                <!-- Headers generated by JS -->
              </tr>
            </thead>
            <tbody id="weeklyBody">
              <!-- Rows generated by JS -->
            </tbody>
          </table>
          <div id="weeklyEmpty" class="hidden text-center text-gray-400 mt-10">
            <p class="text-lg">è«‹é¸æ“‡èµ·å§‹æ—¥æœŸä¸¦æŸ¥è©¢</p>
          </div>
        </div>

        <!-- Empty State Message for Grid -->
        <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none">
          <svg class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
          <p class="text-lg">è«‹é¸æ“‡æ—¥æœŸä¸¦é»æ“ŠæŸ¥è©¢</p>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="p-6 border-t border-gray-100 flex justify-between items-center bg-gray-50">
        <button onclick="resetUI()" class="flex items-center gap-2 px-6 py-2 border-2 border-gray-300 text-gray-500 rounded-xl hover:bg-white transition-all font-medium">
          <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
          ç•«é¢é‡ç½®
        </button>

        <div class="flex gap-4">
          <button id="btn-delete" onclick="deleteData()" class="hidden bg-red-100 text-red-600 border-2 border-red-200 px-6 py-2 rounded-xl font-bold hover:bg-red-200 transition-colors">
            åˆªé™¤æ­¤æ—¥è¨˜éŒ„
          </button>
          
          <button id="btn-submit" onclick="submitRecords()" class="bg-sky-600 text-white px-8 py-2 rounded-xl font-bold hover:bg-sky-700 transition-colors shadow-md flex items-center gap-2">
            <span id="submit-text">çµæŸè¨˜éŒ„ (å„²å­˜)</span>
          </button>
        </div>
      </div>

    </div>
  </div>

  <div class="watermark">æ–‡å›è£½ä½œ</div>

  <!-- Loading & Message -->
  <div id="loader" class="hidden fixed inset-0 loading-overlay flex flex-col items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-sky-600"></div>
    <p id="loader-text" class="mt-4 text-sky-800 font-bold">è³‡æ–™è™•ç†ä¸­...</p>
  </div>

  <div id="messageBox" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-white border-l-4 shadow-xl p-4 rounded-lg z-50 animate__animated animate__fadeInDown">
    <span id="messageText" class="text-gray-800 font-medium"></span>
  </div>

  <script>
    let brushedSeats = new Set();
    let currentMode = 'today'; 
    let currentQueryDate = ''; 

    const today = new Date();
    const formattedToday = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + today.getDate().toString().padStart(2, '0');
    document.getElementById('displayDate').innerText = formattedToday;
    
    // åˆå§‹åŒ–æ—¥æœŸè¼¸å…¥
    document.getElementById('queryDate').valueAsDate = new Date();
    // è¨­å®šé€±æª¢è¦–é è¨­ç‚ºæœ¬é€±ä¸€
    const day = today.getDay();
    const diff = today.getDate() - day + (day == 0 ? -6 : 1); 
    const monday = new Date(today.setDate(diff));
    document.getElementById('weeklyStartDate').valueAsDate = monday;

    window.onload = () => { generateSeats(); };

    function switchTab(mode) {
      currentMode = mode;
      
      // Update Tab Styles
      ['today', 'history', 'weekly'].forEach(m => {
        document.getElementById(`tab-${m}`).className = `tab-btn shrink-0 ${mode === m ? 'active' : ''}`;
        document.getElementById(`controls-${m}`).classList.add('hidden');
      });
      document.getElementById(`controls-${mode}`).classList.remove('hidden');

      // Update View Visibility
      const grid = document.getElementById('seatsGrid');
      const weekly = document.getElementById('weeklyView');
      const empty = document.getElementById('emptyState');
      const btnSubmit = document.getElementById('btn-submit');
      const btnDelete = document.getElementById('btn-delete');

      grid.classList.add('hidden');
      weekly.classList.add('hidden');
      empty.classList.add('hidden');
      btnSubmit.classList.add('hidden');
      btnDelete.classList.add('hidden');

      if (mode === 'today') {
        grid.classList.remove('hidden');
        btnSubmit.classList.remove('hidden');
        document.getElementById('submit-text').innerText = "çµæŸè¨˜éŒ„ (å„²å­˜)";
        btnSubmit.className = "bg-sky-600 text-white px-8 py-2 rounded-xl font-bold hover:bg-sky-700 transition-colors shadow-md flex items-center gap-2";
        resetUI();
      } else if (mode === 'history') {
        grid.classList.remove('hidden');
        empty.classList.remove('hidden');
        document.getElementById('submit-text').innerText = "ä¿®æ”¹ä¸¦å„²å­˜";
        btnSubmit.className = "bg-amber-500 text-white px-8 py-2 rounded-xl font-bold hover:bg-amber-600 transition-colors shadow-md flex items-center gap-2 hidden";
        // History mode starts empty until query
        grid.innerHTML = '';
      } else if (mode === 'weekly') {
        weekly.classList.remove('hidden');
        document.getElementById('weeklyEmpty').classList.remove('hidden');
        document.getElementById('weeklyBody').innerHTML = '';
        document.getElementById('weeklyHeaderRow').innerHTML = '';
      }
    }

    // --- åº§è™Ÿç”Ÿæˆèˆ‡é‚è¼¯ (Today & History) ---
    function generateSeats(seatData = null) {
      const count = parseInt(document.getElementById('studentCount').value);
      const grid = document.getElementById('seatsGrid');
      grid.innerHTML = '';
      if (!seatData) brushedSeats.clear();

      for (let i = 1; i <= count; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.id = `seat-${i}`;
        
        let isBrushed = false;
        if (seatData) {
           isBrushed = (seatData[i] === 'æ˜¯');
        } else {
           isBrushed = brushedSeats.has(i);
        }

        btn.className = isBrushed 
          ? 'seat-btn brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center'
          : 'seat-btn not-brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
        
        if (isBrushed) brushedSeats.add(i);

        btn.onclick = () => {
          if (brushedSeats.has(i)) { 
            brushedSeats.delete(i); 
            btn.className = 'seat-btn not-brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
          } else { 
            brushedSeats.add(i); 
            btn.className = 'seat-btn brushed w-16 h-16 text-xl rounded-full font-bold flex items-center justify-center';
          }
        };
        grid.appendChild(btn);
      }
    }

    // --- é€±æª¢è¦–é‚è¼¯ ---
    async function queryWeeklyData() {
      const startDate = document.getElementById('weeklyStartDate').value;
      if (!startDate) { showMessage("è«‹é¸æ“‡èµ·å§‹æ—¥æœŸ", "border-red-500"); return; }
      if (!validateUrl()) return;

      showLoader("æŸ¥è©¢ä¸€é€±è³‡æ–™ä¸­...");

      try {
        const url = `${GAS_WEB_APP_URL.trim()}?action=weekly_query&startDate=${startDate}`;
        const response = await fetch(url);
        const json = await response.json();
        hideLoader();

        if (json.status === 'success') {
           renderWeeklyTable(json.dates, json.data);
           document.getElementById('weeklyEmpty').classList.add('hidden');
        } else {
           showMessage(json.message, "border-red-500");
        }
      } catch (err) {
        hideLoader();
        showMessage("æŸ¥è©¢å¤±æ•—ï¼š" + err, "border-red-500");
      }
    }

    function renderWeeklyTable(dates, data) {
      const headerRow = document.getElementById('weeklyHeaderRow');
      const body = document.getElementById('weeklyBody');
      headerRow.innerHTML = '<th>åº§è™Ÿ</th>';
      body.innerHTML = '';

      // Render Header
      dates.forEach(d => {
        const th = document.createElement('th');
        th.innerText = d;
        headerRow.appendChild(th);
      });

      // Render Rows
      // keys usually are seat numbers. Sort them.
      const seats = Object.keys(data).map(Number).sort((a,b) => a-b);
      
      seats.forEach(seat => {
        const tr = document.createElement('tr');
        
        // Seat Cell
        const tdSeat = document.createElement('td');
        tdSeat.className = "font-bold text-sky-700 bg-sky-50";
        tdSeat.innerText = seat;
        tr.appendChild(tdSeat);

        // Data Cells
        const weekStatus = data[seat]; // Array of 7 statuses
        weekStatus.forEach(status => {
          const td = document.createElement('td');
          if (status === 'æ˜¯') {
             td.innerHTML = '<span class="text-green-500 font-bold">â—</span>'; // Checkmark
             td.className = "bg-green-50";
          } else if (status === 'å¦') {
             td.innerHTML = '<span class="text-gray-300">â—‹</span>';
          } else {
             td.innerText = "-"; // No data column
             td.className = "text-gray-300 bg-gray-50";
          }
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    // --- é€šç”¨åŠŸèƒ½ (æŸ¥è©¢å–®æ—¥ã€åˆªé™¤ã€å„²å­˜) ---
    function formatDateToMMDD(dateString) {
      const parts = dateString.split('-'); 
      if (parts.length === 3) return `${parts[1]}/${parts[2]}`;
      return dateString;
    }

    async function queryData() {
      const dateInput = document.getElementById('queryDate').value;
      if (!dateInput) { showMessage("è«‹é¸æ“‡æ—¥æœŸ", "border-red-500"); return; }
      currentQueryDate = formatDateToMMDD(dateInput);
      if (!validateUrl()) return;

      showLoader("æŸ¥è©¢ä¸­...");
      try {
        const url = `${GAS_WEB_APP_URL.trim()}?action=query&date=${currentQueryDate}`;
        const response = await fetch(url);
        const json = await response.json();
        hideLoader();

        if (json.status === 'success') {
          document.getElementById('emptyState').classList.add('hidden');
          const seats = Object.keys(json.data).map(Number);
          const maxSeat = seats.length > 0 ? Math.max(...seats) : 30;
          document.getElementById('studentCount').value = maxSeat;
          brushedSeats.clear();
          generateSeats(json.data);
          document.getElementById('btn-submit').classList.remove('hidden');
          document.getElementById('btn-delete').classList.remove('hidden');
          showMessage(`è¼‰å…¥ ${currentQueryDate} è³‡æ–™`, "border-green-500");
        } else {
          showMessage(json.message || "æŸ¥ç„¡è³‡æ–™", "border-amber-500");
          document.getElementById('seatsGrid').innerHTML = '';
          document.getElementById('emptyState').classList.remove('hidden');
          document.getElementById('btn-submit').classList.add('hidden');
          document.getElementById('btn-delete').classList.add('hidden');
        }
      } catch (err) {
        hideLoader();
        showMessage("æŸ¥è©¢å¤±æ•—", "border-red-500");
      }
    }

    async function deleteData() {
      if (!confirm(`ç¢ºå®šåˆªé™¤ ${currentQueryDate} è¨˜éŒ„ï¼Ÿ`)) return;
      if (!validateUrl()) return;
      showLoader("åˆªé™¤ä¸­...");
      try {
        await fetch(GAS_WEB_APP_URL.trim(), {
          method: "POST",
          body: JSON.stringify({ action: 'delete', date: currentQueryDate }),
          headers: { "Content-Type": "text/plain" }
        });
        hideLoader();
        showMessage("å·²é€å‡ºåˆªé™¤è«‹æ±‚", "border-green-500");
        resetUI();
      } catch (err) {
        hideLoader();
        showMessage("å·²é€å‡ºè«‹æ±‚ (è‹¥æœªåæ‡‰è«‹åˆ·æ–°)", "border-gray-500");
      }
    }

    async function submitRecords() {
      if (!validateUrl()) return;
      const count = parseInt(document.getElementById('studentCount').value);
      const records = {};
      for (let i = 1; i <= count; i++) { records[i] = brushedSeats.has(i) ? "æ˜¯" : "å¦"; }
      const targetDate = (currentMode === 'today') ? formattedToday : currentQueryDate;

      showLoader("å„²å­˜ä¸­...");
      try {
        const response = await fetch(GAS_WEB_APP_URL.trim(), {
          method: "POST",
          body: JSON.stringify({ action: 'save', date: targetDate, records: records }),
          headers: { "Content-Type": "text/plain" }
        });
        const result = await response.json();
        hideLoader();
        showMessage(result.message || "å„²å­˜æˆåŠŸ", "border-green-500");
      } catch (err) {
        hideLoader();
        showMessage("å·²é€å‡ºè³‡æ–™", "border-blue-500");
      }
    }

    function validateUrl() {
      if (!GAS_WEB_APP_URL || !GAS_WEB_APP_URL.includes("script.google.com")) {
        showMessage("éŒ¯èª¤ï¼šè«‹å…ˆè¨­å®š GAS ç¶²å€", "border-red-500");
        return false;
      }
      return true;
    }

    function resetUI() {
      if (currentMode === 'today') {
        generateSeats();
      } else if (currentMode === 'history') {
        document.getElementById('seatsGrid').innerHTML = '';
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('btn-submit').classList.add('hidden');
        document.getElementById('btn-delete').classList.add('hidden');
      } else {
        document.getElementById('weeklyBody').innerHTML = '';
        document.getElementById('weeklyHeaderRow').innerHTML = '';
        document.getElementById('weeklyEmpty').classList.remove('hidden');
      }
      showMessage("å·²é‡ç½®", "border-gray-500");
    }

    function showLoader(text) {
      document.getElementById('loader-text').innerText = text;
      document.getElementById('loader').classList.remove('hidden');
    }
    function hideLoader() { document.getElementById('loader').classList.add('hidden'); }
    function showMessage(text, borderColor) {
      const box = document.getElementById('messageBox');
      const txt = document.getElementById('messageText');
      box.className = `fixed top-5 left-1/2 -translate-x-1/2 bg-white border-l-4 shadow-xl p-4 rounded-lg z-50 ${borderColor} animate__animated animate__fadeInDown`;
      txt.innerText = text;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>
